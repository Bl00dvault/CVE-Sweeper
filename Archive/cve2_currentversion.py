# This is designed to be a Nessus to Snort Rule generator based on the "CVE Reference" column in Nessus .csv's
import csv, datetime, os, glob
path = raw_input("Enter the filepath to where your Nessus CSV's are stored: ")
#path = '/home/assessor/CVE_finder/Nessus/Test'
outfile=open("msn_snort_rules.txt","w")
outfile.close()
x = 0
rule_total = 0
#while x < len(glob.glob(os.path.join(path,'*.csv'))):
for filename in glob.glob(os.path.join(path,'*.csv')):
	cve_row = []
	ip_row = []
	with open(filename) as csvfile:
		reader = csv.DictReader(csvfile)
		for row in reader:
			if row['CVE'] != '':
				cve_row.append(row['CVE'][4:])
				ip_row.append(row['Host'])
	rules = open('community.rules', 'r')
	reader = rules.read().splitlines()
	outfile=open("msn_snort_rules.txt","a")
	outfile.write("--------------------Rules generated on " + filename + " at " + str(datetime.datetime.now())[:16] + "--------------------")
	i = 0
	cve_store = []
	for s in reader:
		for item in list(set(cve_row)):
			if item in s:			
				if (s[0]) == "#":
					outfile.write("\n")
					outfile.write(s[2:])
					cve_store.append(item)
					i +=1
				else:
					outfile.write("\n")
					outfile.write(s[0:])
					cve_store.append(item)
					i +=1
	outfile.write("\n")
	outfile.write("\n")
	if str(list(set(cve_store))) != '[]':
		outfile.write("----------------------------------CVE's Popped----------------------------------")
		outfile.write("\n")
		outfile.write(str(list(set(cve_store)))),				
		outfile.write("\n")
		outfile.write("\n")
		outfile.write("---------------------------------IP's Vulnerable---------------------------------")
		outfile.write("\n")
		outfile.write(str(list(set(ip_row)))),
		outfile.write("\n")
	outfile.write("---------------------------This script generated " + str(i) + " Snort rules based on the Nessus data provided!---------------------------")
	rule_total = int(i) + int(rule_total)
	outfile.write("\n")
	outfile.write("\n")
	outfile.write("\n")
	outfile.write("\n")				
x += 1		
outfile.write("---------------------------This script generated " + str(rule_total) + " Snort rules for this mission!---------------------------")
outfile.close()
